# 上游更新与汉化维护流程

## 目标
- 跟进官方 `openai/codex` 上游更新。
- 保持中文可见文案完整（含多级菜单、斜杠命令相关弹窗、skills 说明）。
- 默认仅做“更新提醒”，不自动升级，不覆盖用户文件。

## 一、上游更新检查（每次必做）
1. 获取上游最新：
   - `git fetch upstream`
2. 查看差异提交：
   - `git log --oneline HEAD..upstream/main`
3. 若工作区是脏树（常见）：
   - 不做强制 reset。
   - 优先用 `git show <commit> | git apply --3way` 把上游改动补进当前工作区（避免破坏本地改动）。
4. 记录本次同步到的上游提交号（写入交付说明）。

## 二、版本号策略（避免显示 0.0.0）
当前仓库 workspace 版本是 `0.0.0`（开发占位）。

已支持构建时覆盖版本号：
- 环境变量：`CODEX_CLI_VERSION_OVERRIDE`
- 示例：
  - PowerShell: `$env:CODEX_CLI_VERSION_OVERRIDE='0.101.0'`
  - 然后构建 `cargo build -p codex-cli`

生效范围：
- `codex --version`
- TUI 顶部版本显示
- 更新弹窗中的“当前版本”
- 相关 telemetry 版本字段

建议：
- 默认用“最新稳定版”号（例如 `0.101.0`）。
- 预发布版（如 `0.102.0-alpha.*`）只在明确要跟 alpha 时使用。

## 三、更新提醒策略（仅提醒，不自动更新）
- 启动时检查更新：由 `check_for_update_on_startup` 控制。
- 行为：
  - 只检查并提示（banner/popup）。
  - 绝不自动下载、绝不自动覆盖安装。
- 用户可选择“稍后”或“不再提醒此版本”。

## 四、汉化标准流程（必须全量，不可零散）
1. 全量扫描
- 扫描 TUI 可见字符串（提示、弹窗、状态行、斜杠命令下级菜单、skills 列表说明）。
- 用关键词聚合（例如 `Tip`, `Press enter`, `Esc`, `model:`, `directory:`, `OpenAI Codex`, `MCP startup` 等）。

2. 一次性补齐
- 优先用 `tr(en, zh)` 或等价中文化路径。
- 多级菜单返回逻辑同时检查（Esc/左键逐层返回）。
- skills 说明统一走中文映射，避免每个弹窗重复写翻译。

3. 回归复扫
- 再跑一轮同样扫描，确认没有新增遗漏。
- 核查截图/启动页高频可见区域。

4. 构建验证
- 最少执行：`cargo test -p codex-tui --no-run`
- 若发布构建失败，优先排查磁盘空间，再重试。

## 五、输入与退出交互约定（本地定制）
- 多层菜单：
  - `Esc`：返回上一层（逐层）。
  - `Left`：返回上一层（逐层）。
- `Ctrl+C` 冲突规避：
  - 连按计数策略：第 3 次中断任务，第 4 次退出。
  - 主要用于降低和复制操作冲突。

## 六、鼠标选中自动复制说明
这是终端能力，不是 TUI 内核强控项。
- Windows Terminal：可开启 `copyOnSelect`。
- 如果没开自动复制，建议使用终端原生复制快捷键（常见为 `Ctrl+Shift+C`）。

## 七、部署到正式入口（Windows）
原则：旧进程不受影响，新开进程使用新版本。

建议步骤：
1. 构建新二进制（含版本覆盖）。
2. 输出为新文件名（如 `codex-0.101.0.exe`），不要覆盖正在占用的 `codex-current.exe`。
3. 更新启动脚本 `codex.cmd` / `codex.ps1` 指向新文件。
4. 验证：`codex --version`。

## 八、给下一个 AI 的执行清单
1. `git fetch upstream`，查看 `HEAD..upstream/main`。
2. 同步上游（脏树优先 `git apply --3way`）。
3. 设 `CODEX_CLI_VERSION_OVERRIDE` 为目标稳定版本并构建。
4. 做“全量汉化扫描 -> 一次性补齐 -> 复扫”。
5. 运行 `cargo test -p codex-tui --no-run`。
6. 部署新 exe 到 bin 路径并切换启动脚本。
7. 回传：
   - 上游基线提交
   - 当前显示版本
   - 本轮新增/修复的汉化点
   - 未完成项（若有）
